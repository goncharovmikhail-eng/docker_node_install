# Роль для управления Docker: установка, очистка и бекапирование
- ОС: deb, redos
- Эта роль автоматически устанавливает нужную версию Docker и Docker Compose на вашем сервере, а также настраивает процессы очистки Docker-ресурсов, сощдания коммитов и push по крону.

## Основные функции

### 1. Установка Docker и Docker Compose
Роль устанавливает необходимую версию Docker и Docker Compose, обеспечивая корректную работу с контейнерами и образами на сервере.

### 2. Очищение Docker-ресурсов
Функция очистки запускает процесс удаления неактивных или неиспользуемых Docker-ресурсов:

- **Контейнеры**: Удаляются неработающие контейнеры с помощью команды `docker container prune`.
- **Образы**: Удаляются неиспользуемые образы с помощью команды `docker image prune`.
- **Тома**: Удаляются неиспользуемые Docker-тома с помощью команды `docker volume prune`.

Скрипт предоставляет возможность ограничить очистку только теми объектами, которые старше определенного количества дней, используя параметр фильтра `--filter until=XXh` (где `XX` — это количество часов). Этот фильтр активируется через переменную `USE_PRUNE_FILTER_UNTIL`.

### 3. Проверка необходимости очистки
Перед выполнением очистки скрипт проверяет, превышает ли использование диска или инодов заданный порог. Если порог превышен, скрипт выполняет очистку Docker-ресурсов. Если фильтрация по времени активирована, сначала очищаются только элементы старше заданного количества дней.

### 4. Бекапирование Docker-контейнеров
Бекапирование контейнеров происходит каждое воскресенье в 4:00 утра. В процессе бекапа создается новый образ  [имя контейнера]:`latest`.

- После первого запуска рекомендуется обновить "image: " в файле `docker-compose.yml` имя образа контейнера на `[имя контейнера]:latest`.
- Каждый новый образ с тем же именем и тегом заменяет предыдущий, что предотвращает накопление лишних образов и засорение памяти.

### 5. Правила использования в inventory
В вашем `inventory` необходимо указать следующие параметры:

#### Параметры:

- `docker_backup: true` — включает процесс бекапирования контейнеров.
- `docker_projects` — список проектов с контейнерами, которые должны быть задействованы для бекапирования. Если этот параметр не определен, будут созданы образы для всех активных контейнеров.

#### Пример inventory:

```yaml
docker_backup: true
# docker_projects:
#   migrator_mysql:
#     - my_migrator
#   keycloack24:
#     - keycloack24-postgres-1
```
Если docker_projects не определен, роль будет создавать образы для всех работающих контейнеров на хосте.

